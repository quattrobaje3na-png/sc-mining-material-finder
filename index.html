function scan() {
            const out = document.getElementById('results');
            const selectedSys = document.getElementById('sys-select').value;
            const picks = Array.from(document.querySelectorAll('.ore-sel')).map(s => s.value).filter(v => v);
            out.innerHTML = "";
            if (!oreData || !probData) return;

            const mapping = referenceData.location_mapping || {};
            const excluded = filterData.exclude_locations || [];
            const nyxPrefixes = ["BGR-", "CAJ-", "DLO-", "EMM-", "FSN-", "GRP-", "HJS-", "JWY-", "KKE-", "LHB-", "MNK-", "NBD-", "RSC-", "WDH-", "YKA-"];

            let allResults = [];

            for (let locId in oreData) {
                if (excluded.includes(locId)) continue;
                const locUp = locId.toUpperCase();
                
                let locSystem = "UNKNOWN";
                if (locUp.includes("NYX") || nyxPrefixes.some(p => locUp.startsWith(p))) {
                    locSystem = "Nyx";
                } else {
                    for (let sys in (sortingData.star_system_groups || {})) {
                        if (sortingData.star_system_groups[sys].some(id => locId.startsWith(id))) {
                            locSystem = sys; break;
                        }
                    }
                }

                if (selectedSys !== "ALL" && selectedSys !== locSystem) continue;

                let matches = [];
                let totalProb = 0; // TRACK TOTAL FOR SORTING

                picks.forEach(p => {
                    const locOres = oreData[locId].ores || oreData[locId];
                    const matKey = Object.keys(locOres).find(k => k.toUpperCase() === p.toUpperCase());
                    if (matKey && locOres[matKey]) {
                        const hud = getBestHUD(p, locSystem, locId);
                        const probValue = locOres[matKey].prob !== undefined ? locOres[matKey].prob : locOres[matKey];
                        
                        totalProb += probValue; // Accumulate weight
                        matches.push({ name: p.toUpperCase(), prob: (probValue * 100).toFixed(1), rock: hud.type, sig: hud.sig });
                    }
                });

                if (matches.length > 0) {
                    allResults.push({
                        locId: locId,
                        system: locSystem,
                        displayName: (mapping[locId] || locId).toUpperCase(),
                        matches: matches,
                        totalWeight: totalProb // Sorting criteria
                    });
                }
            }

            // SORT RESULTS BY HIGHEST TOTAL PERCENTAGE
            allResults.sort((a, b) => b.totalWeight - a.totalWeight);

            // RENDER SORTED CARDS
            allResults.forEach(res => {
                const card = document.createElement('div');
                card.className = "card";
                card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span class="loc-title">${res.displayName}</span>
                    <span style="font-size:9px; color:#554400; border:1px solid #332200; padding:1px 4px;">${res.system.toUpperCase()}</span>
                </div>` + res.matches.map(m => `<div class="row"><div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; color:#fff;">${m.name} <span class="sig-pill">${m.sig}</span></span>
                    <span class="meta-text">HUNT: ${m.rock}</span></div><span class="prob">${m.prob}%</span></div>`).join('');
                out.appendChild(card);
            });
        }
